{"version":3,"file":"hooked.js","sources":["../src/index.mjs"],"sourcesContent":["const OUTSIDE_RUN = Symbol(\"outside_run\");\r\nlet currentHookStateIndex;\r\nlet currentRun = OUTSIDE_RUN;\r\nconst hookStateMap = new (WeakMap ? WeakMap : Map)();\r\nconst reset = () => {\r\n  currentRun = OUTSIDE_RUN;\r\n};\r\nconst createHookApi = name => {\r\n  const hookStates = hookStateMap.get(currentRun.context);\r\n  if (hookStates[currentHookStateIndex] === undefined) {\r\n    hookStates[currentHookStateIndex] = {};\r\n  }\r\n  const hookState = hookStates[currentHookStateIndex];\r\n  const onStateChange = currentRun.onStateChange;\r\n  return {\r\n    onCleanUp(callback) {\r\n      hookState.cleanUp = callback;\r\n    },\r\n    beforeNextRun(callback) {\r\n      hookState.beforeNextRun = callback;\r\n    },\r\n    afterCurrentRun(callback) {\r\n      hookState.afterCurrentRun = callback;\r\n    },\r\n    getApi() {\r\n      return currentRun.api;\r\n    },\r\n    getContext() {\r\n      return currentRun.context;\r\n    },\r\n    getState(initialState) {\r\n      if (hookState.state === undefined) hookState.state = initialState;\r\n      return hookState.state;\r\n    },\r\n    setState(value, silent = false) {\r\n      let oldValue = hookState.state;\r\n      hookState.state = value;\r\n      if (!silent && onStateChange) onStateChange(name, oldValue, value);\r\n    }\r\n  };\r\n};\r\nexport const createHook = (name, hook) => {\r\n  return (...args) => {\r\n    if (currentRun.context === OUTSIDE_RUN)\r\n      throw new Error(\"Hook was called outside of run()!\");\r\n    currentHookStateIndex++;\r\n    const hookApi = createHookApi(name);\r\n    return hook(...args, hookApi);\r\n  };\r\n};\r\nfunction runLifeCycleCallback(name, hookStates, length) {\r\n  let index = length;\r\n  while (index--) {\r\n    const hookState = hookStates[length - index - 1];\r\n    if (hookState[name]) {\r\n      hookState[name]();\r\n      hookState[name] = undefined;\r\n    }\r\n  }\r\n}\r\nexport const run = (\r\n  callback,\r\n  { context, api, onStateChange = () => {} } = {}\r\n) => {\r\n  if (!context) context = callback;\r\n  if (!(context instanceof Object))\r\n    throw new Error(\"Run was called without a valid object context!\");\r\n  if (currentRun !== OUTSIDE_RUN)\r\n    throw new Error(\"Run was called before the end of the previous run!\");\r\n  currentRun = {\r\n    context,\r\n    api,\r\n    onStateChange\r\n  };\r\n  currentHookStateIndex = -1;\r\n  let init = false;\r\n  if (!hookStateMap.has(context)) {\r\n    hookStateMap.set(context, []);\r\n    init = true;\r\n  }\r\n  const hookStates = hookStateMap.get(currentRun.context);\r\n  const length = hookStates.length;\r\n  runLifeCycleCallback(\"beforeNextRun\", hookStates, length);\r\n  const result = callback();\r\n  if (result instanceof Promise) {\r\n    return result.then(value => {\r\n      runLifeCycleCallback(\r\n        \"afterCurrentRun\",\r\n        hookStates,\r\n        init ? hookStates.length : length\r\n      );\r\n      reset();\r\n      return value;\r\n    });\r\n  } else {\r\n    runLifeCycleCallback(\r\n      \"afterCurrentRun\",\r\n      hookStates,\r\n      init ? hookStates.length : length\r\n    );\r\n    reset();\r\n    return result;\r\n  }\r\n};\r\nexport const useReducer = createHook(\r\n  \"useReducer\",\r\n  (reducer, initialState, { getState, setState }) => {\r\n    const state = getState(initialState);\r\n    return [\r\n      state,\r\n      action => {\r\n        setState(reducer(state, action));\r\n      }\r\n    ];\r\n  }\r\n);\r\nexport const useState = createHook(\"useState\", initialState => {\r\n  const [state, dispatch] = useReducer((_, action) => {\r\n    return action.value;\r\n  }, initialState);\r\n\r\n  return [\r\n    state,\r\n    newState =>\r\n      dispatch({\r\n        type: \"set_state\",\r\n        value: newState\r\n      })\r\n  ];\r\n});\r\n\r\nexport const useEffect = createHook(\"useEffect\", (effect, ...rest) => {\r\n  let valuesIn;\r\n  if (rest.length > 1) {\r\n    valuesIn = rest[0];\r\n  }\r\n  const { getState, setState, onCleanUp, afterCurrentRun } = rest[\r\n    rest.length - 1\r\n  ];\r\n  let { values, cleanUp } = getState({});\r\n  let nothingChanged = false;\r\n  if (values !== valuesIn && values && values.length > 0) {\r\n    nothingChanged = true;\r\n    let index = values.length;\r\n\r\n    while (index--) {\r\n      if (valuesIn[index] !== values[index]) {\r\n        nothingChanged = false;\r\n        break;\r\n      }\r\n    }\r\n    values = valuesIn;\r\n  }\r\n  if (!nothingChanged) {\r\n    if (cleanUp) cleanUp();\r\n    afterCurrentRun(() => {\r\n      cleanUp = effect();\r\n      setState({ values: valuesIn, cleanUp });\r\n      if (cleanUp) {\r\n        onCleanUp(() => {\r\n          cleanUp();\r\n        });\r\n      } else {\r\n        onCleanUp(undefined);\r\n      }\r\n    });\r\n  }\r\n});\r\n"],"names":[],"mappings":"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"}